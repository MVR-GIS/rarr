---
title: "Update Risk Analysis Report Test Data
date: "`r Sys.Date()`"
---

# Introduction
The purpose of this document is to document the techniques for updating the risk analysis test data used in this package. 

# Manual Export Using SQL Develoer
This section describes how to process data manually exported from SQLDeveloper. 

```{r import-libraries}
library(stringr)
library(readr)
library(DBI)
library(ROracle)
library(keyring)
```

```{r, eval=FALSE}
# Manually export all views from MVR egis-db BrandonRoad to the package 
# folder inst/extdata. 

# Cleanup file names from SQL Developer export
extdata <- system.file("extdata", package = "rarr")
data_files <- list.files(extdata)
data_files_path <- file.path(extdata, data_files)
renamed_files <- str_remove(data_files, "_DATA_VIEW")
renamed_files_path <- file.path(extdata, renamed_files)
file.rename(from = data_files_path,
            to = renamed_files_path)
```

```{r import-csv-files, eval=FALSE}
risk_db              <- read_csv(system.file("extdata", 
                                             "RISK_MAIN_VIEW.csv",
                                             package = "rarr"),
                                 show_col_types = FALSE)
events_db            <- read_csv(system.file("extdata", 
                                             "EVENTS_MAIN_VIEW.csv",
                                             package = "rarr"),
                                 show_col_types = FALSE)
discussion_db        <- read_csv(system.file("extdata",
                                             "DISCUSSION_LOG_MAIN_VIEW.csv",
                                             package = "rarr"),
                                 show_col_types = FALSE)
action_db            <- read_csv(system.file("extdata", 
                                             "ACTION_MAIN_VIEW.csv",
                                             package = "rarr"),
                                 show_col_types = FALSE)
decision_db          <- read_csv(system.file("extdata",
                                             "DECISION_MAIN_VIEW.csv",
                                             package = "rarr"),
                                 show_col_types = FALSE)
rel_action_action_db <- read_csv(system.file("extdata",
                                             "REL_ACTION_ACTION_MAIN_VIEW.csv",
                                             package = "rarr"),
                                 show_col_types = FALSE)
rel_dec_dec_db       <- read_csv(system.file("extdata",
                                             "REL_DEC_DEC_MAIN_VIEW.csv",
                                             package = "rarr"),
                                 show_col_types = FALSE)
rel_dec_action_db    <- read_csv(system.file("extdata",
                                             "REL_DEC_ACTION_MAIN_VIEW.csv",
                                             package = "rarr"),
                                 show_col_types = FALSE)
rel_risk_action_db   <- read_csv(system.file("extdata",
                                             "REL_RISK_ACTION_MAIN_VIEW.csv",
                                             package = "rarr"),
                                 show_col_types = FALSE)
rel_risk_dec_db      <- read_csv(system.file("extdata",
                                             "REL_RISK_DEC_MAIN_VIEW.csv",
                                             package = "rarr"),
                                 show_col_types = FALSE)
rel_risk_risk_db     <- read_csv(system.file("extdata",
                                             "REL_RISK_RISK_MAIN_VIEW.csv",
                                             package = "rarr"),
                                 show_col_types = FALSE)
```

```{r convert-dates, eval=FALSE}
risk_db       <- convert_date(risk_db)
events_db     <- convert_date(events_db)
discussion_db <- convert_date(discussion_db)
action_db     <- convert_date(action_db)
decision_db   <- convert_date(decision_db)
```

# Automatic Update Using `ROracle`
This section describes how to make a direct connection to the project Oracle database and export the data tables from this connection. 

```{r oracle-connection}
# Use the `keyring` package to save the database username and password in the 
# system credential store
key_service <- "egis-db-brandonroad"
user_name <- "BrandonRoad"
# Set once on each computer prior to building book
# keyring::key_set(service = key_service, username = user_name)

# Make Oracle connection
drv  <- DBI::dbDriver("Oracle")
host <- "egis-db"
port <- "1521"
sid  <- "B5SDEDP1"
connect_string <- paste0(
  "(DESCRIPTION=",
  "(ADDRESS=(PROTOCOL=tcp)(HOST=", host, ")(PORT=", port, "))",
  "(CONNECT_DATA=(SID=", sid, ")))")
 
con_roracle <- ROracle::dbConnect(drv, 
                                  username = user_name, 
                                  password = key_get(key_service, user_name),
                                  dbname   = connect_string)
```

```{r import-oracle-tables, echo=FALSE, warning=FALSE, message=FALSE}
# Import tables from Oracle
risk_db              <- ROracle::dbReadTable(con_roracle, 
                                             "RISK_MAIN_VIEW")
events_db            <- ROracle::dbReadTable(con_roracle, 
                                             "EVENTS_MAIN_VIEW")
discussion_db        <- ROracle::dbReadTable(con_roracle, 
                                             "DISCUSSION_LOG_MAIN_VIEW")
action_db            <- ROracle::dbReadTable(con_roracle, 
                                             "ACTION_MAIN_VIEW")
decision_db          <- ROracle::dbReadTable(con_roracle, 
                                             "DECISION_MAIN_VIEW")
rel_action_action_db <- ROracle::dbReadTable(con_roracle, 
                                             "REL_ACTION_ACTION_MAIN_VIEW")
rel_dec_dec_db       <- ROracle::dbReadTable(con_roracle, 
                                             "REL_DEC_DEC_MAIN_VIEW")
rel_dec_action_db    <- ROracle::dbReadTable(con_roracle, 
                                             "REL_DEC_ACTION_MAIN_VIEW")
rel_risk_action_db   <- ROracle::dbReadTable(con_roracle, 
                                             "REL_RISK_ACTION_MAIN_VIEW")
rel_risk_dec_db      <- ROracle::dbReadTable(con_roracle, 
                                             "REL_RISK_DEC_MAIN_VIEW")
rel_risk_risk_db     <- ROracle::dbReadTable(con_roracle, 
                                             "REL_RISK_RISK_MAIN_VIEW")

# Disconnect from the database
ROracle::dbDisconnect(con_roracle)
```

```{r save-package-data}
usethis::use_data(risk_db,
                  events_db,
                  discussion_db,
                  action_db,
                  decision_db,
                  rel_action_action_db,
                  rel_dec_dec_db,
                  rel_dec_action_db,
                  rel_risk_action_db,
                  rel_risk_dec_db,
                  rel_risk_risk_db,
                  overwrite = TRUE)
```

